generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("FREE") // FREE, PRO, ENTERPRISE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     User[]
  templates Template[]
  documents Document[]
  processes Process[]
}

enum Role {
  ADMIN
  LEADER
  MANAGER
  MEMBER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  
  // Multi-tenancy
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  
  role      Role     @default(MEMBER)
  
  documents Document[]
  
  // Process membership (for MANAGER/MEMBER)
  processId String?
  process   Process? @relation(fields: [processId], references: [id])
  
  // Leader assignments (if user is a LEADER)
  leaderOf  ProcessLeader[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NEW: Process/Area Entity
model Process {
  id          String   @id @default(uuid())
  name        String
  description String?

  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  // Leaders assigned to this process (M:N)
  leaders     ProcessLeader[]

  // Users (members) in this process
  members     User[]

  // Templates scoped to this process
  templates   Template[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Join Table: Process <-> Leader (User)
model ProcessLeader {
  id        String   @id @default(uuid())
  
  processId String
  process   Process  @relation(fields: [processId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([processId, userId])
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  
  companyId String
  
  metadata  Json?
  
  createdAt DateTime @default(now())
}

model Template {
  id          String   @id @default(uuid())
  name        String
  description String?
  structure   Json     @default("{}") // Stores the React DnD state
  
  isPublished Boolean  @default(false)

  // PDF Background
  pdfUrl      String? // Relative path to the uploaded PDF
  pdfWidth    Int?
  pdfHeight   Int?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  
  // Scope to Process (optional for backwards compatibility)
  processId   String?
  process     Process? @relation(fields: [processId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  documents   Document[]
}

model Document {
  id          String   @id @default(uuid())
  
  status      String   @default("DRAFT") // DRAFT, SENT, VIEWED, COMPLETED
  
  // Recipient Info
  recipientEmail String
  recipientName  String?
  
  // Security
  token       String   @unique // Public access token
  
  // Data Snapshot (What was sent)
  structure   Json     // Copy of template structure at send time
  pdfUrl      String?  // Copy of PDF URL
  
  // Data Capture (What was filled)
  data        Json     @default("{}") // { "block-id": "value" }
  
  // Relations
  templateId  String
  template    Template @relation(fields: [templateId], references: [id])
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  sentAt      DateTime?
  viewedAt    DateTime?
  signedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
